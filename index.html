<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>영수증 스캐너</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        
        // 카메라 전환 (전면 ↔ 후면)
        function switchCamera() {
            updateStatus('카메라 전환 중...');
            
            // 현재 스트림 중지
            if (stream) {
                stream.getTracks().forEach(function(track) {
                    track.stop();
                });
                stream = null;
            }
            
            // 카메라 모드 전환
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            var cameraName = currentFacingMode === 'environment' ? '후면' : '전면';
            
            // 더 호환성 높은 방식으로 시도
            var constraints = {
                video: {
                    facingMode: currentFacingMode, // exact 제거
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(mediaStream) {
                    stream = mediaStream;
                    var video = document.getElementById('camera');
                    video.srcObject = stream;
                    video.play();
                    updateStatus(cameraName + ' 카메라로 전환 성공');
                })
                .catch(function(error) {
                    console.error('카메라 전환 오류:', error);
                    updateStatus('카메라 전환 실패, 다시 시도...');
                    
                    // 더 간단한 방식으로 재시도
                    var simpleConstraints = {
                        video: currentFacingMode === 'environment' ? 
                            { facingMode: { ideal: 'environment' } } : 
                            { facingMode: { ideal: 'user' } }
                    };
                    
                    navigator.mediaDevices.getUserMedia(simpleConstraints)
                        .then(function(mediaStream) {
                            stream = mediaStream;
                            var video = document.getElementById('camera');
                            video.srcObject = stream;
                            video.play();
                            updateStatus(cameraName + ' 카메라로 전환 성공 (호환 모드)');
                        })
                        .catch(function(error2) {
                            console.error('재시도도 실패:', error2);
                            updateStatus('카메라 전환 실패: ' + error2.message);
                            
                            // 원래 모드로 되돌리기
                            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
                            
                            // 기본 카메라로 다시 시작
                            setTimeout(function() {
                                startCamera();
                            }, 1000);
                        });
                });
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .camera-section {
            text-align: center;
            margin-bottom: 30px;
        }
        video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: #f9f9f9;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .upload-btn {
            background: #28a745;
        }
        .upload-btn:hover {
            background: #1e7e34;
        }
        input[type="file"] {
            display: none;
        }
        .results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        .results.show {
            display: block;
        }
        .result-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .loading.show {
            display: block;
        }
        .debug {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📱 영수증 스캐너</h1>
        
        <div class="camera-section">
            <video id="camera" autoplay playsinline></video>
        </div>
        
        <div class="controls">
            <button id="startBtn">📷 후면 카메라 시작</button>
            <button id="captureBtn" disabled>📸 사진 촬영</button>
            <button id="uploadBtn" class="upload-btn">📁 사진 업로드</button>
            <input type="file" id="fileInput" accept="image/*">
        </div>
        
        <div id="loading" class="loading">
            <p>처리 중...</p>
        </div>
        
        <div id="results" class="results">
            <h3>분석 결과</h3>
            <div class="result-item">
                <strong>날짜:</strong> <span id="resultDate">-</span>
            </div>
            <div class="result-item">
                <strong>업체명:</strong> <span id="resultBusiness">-</span>
            </div>
            <div class="result-item">
                <strong>금액:</strong> <span id="resultAmount">-</span>
            </div>
            <div class="result-item">
                <strong>적요:</strong> <span id="resultCategory">-</span>
            </div>
        </div>
        
        <div class="debug">
            <strong>상태:</strong> <span id="status">페이지 로드됨</span>
        </div>
    </div>

    <script>
        // 전역 변수
        var stream = null;
        var imageData = null;
        var currentFacingMode = 'environment'; // 현재 카메라 모드
        
        // 상태 업데이트 함수
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log(message);
        }
        
        // 페이지 로드 시 실행
        window.onload = function() {
            updateStatus('JavaScript 로드 완료');
            
            // 사용 가능한 카메라 확인
            checkAvailableCameras();
            
            // 버튼 이벤트 등록
            document.getElementById('startBtn').onclick = startCamera;
            document.getElementById('captureBtn').onclick = capturePhoto;
            document.getElementById('uploadBtn').onclick = function() {
                document.getElementById('fileInput').click();
            };
            document.getElementById('fileInput').onchange = handleFile;
            
            updateStatus('이벤트 리스너 등록 완료');
        };
        
        // 사용 가능한 카메라 확인
        function checkAvailableCameras() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                updateStatus('카메라 정보를 확인할 수 없습니다');
                return;
            }
            
            navigator.mediaDevices.enumerateDevices()
                .then(function(devices) {
                    var videoDevices = devices.filter(function(device) {
                        return device.kind === 'videoinput';
                    });
                    
                    updateStatus('카메라 ' + videoDevices.length + '개 감지됨');
                    console.log('사용 가능한 카메라:', videoDevices);
                    
                    // 카메라가 1개뿐이면 전환 버튼 숨기기
                    if (videoDevices.length <= 1) {
                        document.getElementById('switchBtn').style.display = 'none';
                        updateStatus('카메라 1개 감지 - 전환 버튼 숨김');
                    }
                })
                .catch(function(error) {
                    console.error('카메라 확인 오류:', error);
                    updateStatus('카메라 확인 오류: ' + error.message);
                });
        }
        
        // 카메라 시작 (후면 카메라만)
        function startCamera() {
            updateStatus('후면 카메라 시작 시도 중...');
            
            if (!navigator.mediaDevices) {
                alert('카메라가 지원되지 않습니다');
                return;
            }
            
            // 후면 카메라만 시도
            var constraints = {
                video: {
                    facingMode: 'environment', // 후면 카메라
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(mediaStream) {
                    stream = mediaStream;
                    var video = document.getElementById('camera');
                    video.srcObject = stream;
                    video.play();
                    
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('startBtn').textContent = '🔄 카메라 재시작';
                    updateStatus('후면 카메라 시작 성공! 영수증을 찍어보세요');
                })
                .catch(function(error) {
                    console.error('후면 카메라 오류:', error);
                    updateStatus('후면 카메라 실패, 기본 카메라로 시도...');
                    
                    // 후면 카메라 실패 시 그냥 기본 카메라
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(function(mediaStream) {
                            stream = mediaStream;
                            var video = document.getElementById('camera');
                            video.srcObject = stream;
                            video.play();
                            
                            document.getElementById('captureBtn').disabled = false;
                            document.getElementById('startBtn').textContent = '🔄 카메라 재시작';
                            updateStatus('기본 카메라로 시작됨');
                        })
                        .catch(function(error2) {
                            console.error('모든 카메라 오류:', error2);
                            updateStatus('카메라 오류: ' + error2.message);
                            alert('카메라를 시작할 수 없습니다. 권한을 확인해주세요.');
                        });
                });
        }
        
        // 사진 촬영
        function capturePhoto() {
            updateStatus('사진 촬영 중...');
            
            var video = document.getElementById('camera');
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            imageData = canvas.toDataURL('image/jpeg');
            processImage();
        }
        
        // 파일 업로드
        function handleFile(event) {
            updateStatus('파일 업로드 중...');
            
            var file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('이미지 파일만 업로드 가능합니다');
                return;
            }
            
            var reader = new FileReader();
            reader.onload = function(e) {
                imageData = e.target.result;
                processImage();
            };
            reader.readAsDataURL(file);
        }
        
        // 이미지 처리 (시뮬레이션)
        function processImage() {
            updateStatus('이미지 분석 중...');
            
            // 로딩 표시
            document.getElementById('loading').className = 'loading show';
            document.getElementById('results').className = 'results';
            
            // 2초 후 결과 표시 (시뮬레이션)
            setTimeout(function() {
                var businesses = ['스타벅스', '맥도날드', 'GS25', '이마트', '롯데리아'];
                var categories = ['간식대', '식대', '생필품', '교통비'];
                
                var business = businesses[Math.floor(Math.random() * businesses.length)];
                var amount = Math.floor(Math.random() * 50000) + 1000;
                var category = categories[Math.floor(Math.random() * categories.length)];
                var today = new Date().toISOString().split('T')[0];
                
                // 결과 표시
                document.getElementById('resultDate').textContent = today;
                document.getElementById('resultBusiness').textContent = business;
                document.getElementById('resultAmount').textContent = amount.toLocaleString() + '원';
                document.getElementById('resultCategory').textContent = category;
                
                // 로딩 숨기고 결과 표시
                document.getElementById('loading').className = 'loading';
                document.getElementById('results').className = 'results show';
                
                updateStatus('분석 완료');
            }, 2000);
        }
    </script>
</body>
</html>
