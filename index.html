<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ìˆ˜ì¦ ìŠ¤ìºë„ˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        
        // ì¹´ë©”ë¼ ì „í™˜ (ì „ë©´ â†” í›„ë©´)
        function switchCamera() {
            updateStatus('ì¹´ë©”ë¼ ì „í™˜ ì¤‘...');
            
            // í˜„ì¬ ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
            if (stream) {
                stream.getTracks().forEach(function(track) {
                    track.stop();
                });
                stream = null;
            }
            
            // ì¹´ë©”ë¼ ëª¨ë“œ ì „í™˜
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            var cameraName = currentFacingMode === 'environment' ? 'í›„ë©´' : 'ì „ë©´';
            
            // ë” í˜¸í™˜ì„± ë†’ì€ ë°©ì‹ìœ¼ë¡œ ì‹œë„
            var constraints = {
                video: {
                    facingMode: currentFacingMode, // exact ì œê±°
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(mediaStream) {
                    stream = mediaStream;
                    var video = document.getElementById('camera');
                    video.srcObject = stream;
                    video.play();
                    updateStatus(cameraName + ' ì¹´ë©”ë¼ë¡œ ì „í™˜ ì„±ê³µ');
                })
                .catch(function(error) {
                    console.error('ì¹´ë©”ë¼ ì „í™˜ ì˜¤ë¥˜:', error);
                    updateStatus('ì¹´ë©”ë¼ ì „í™˜ ì‹¤íŒ¨, ë‹¤ì‹œ ì‹œë„...');
                    
                    // ë” ê°„ë‹¨í•œ ë°©ì‹ìœ¼ë¡œ ì¬ì‹œë„
                    var simpleConstraints = {
                        video: currentFacingMode === 'environment' ? 
                            { facingMode: { ideal: 'environment' } } : 
                            { facingMode: { ideal: 'user' } }
                    };
                    
                    navigator.mediaDevices.getUserMedia(simpleConstraints)
                        .then(function(mediaStream) {
                            stream = mediaStream;
                            var video = document.getElementById('camera');
                            video.srcObject = stream;
                            video.play();
                            updateStatus(cameraName + ' ì¹´ë©”ë¼ë¡œ ì „í™˜ ì„±ê³µ (í˜¸í™˜ ëª¨ë“œ)');
                        })
                        .catch(function(error2) {
                            console.error('ì¬ì‹œë„ë„ ì‹¤íŒ¨:', error2);
                            updateStatus('ì¹´ë©”ë¼ ì „í™˜ ì‹¤íŒ¨: ' + error2.message);
                            
                            // ì›ë˜ ëª¨ë“œë¡œ ë˜ëŒë¦¬ê¸°
                            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
                            
                            // ê¸°ë³¸ ì¹´ë©”ë¼ë¡œ ë‹¤ì‹œ ì‹œì‘
                            setTimeout(function() {
                                startCamera();
                            }, 1000);
                        });
                });
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .camera-section {
            text-align: center;
            margin-bottom: 30px;
        }
        video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: #f9f9f9;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .upload-btn {
            background: #28a745;
        }
        .upload-btn:hover {
            background: #1e7e34;
        }
        input[type="file"] {
            display: none;
        }
        .results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        .results.show {
            display: block;
        }
        .result-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .loading.show {
            display: block;
        }
        .debug {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± ì˜ìˆ˜ì¦ ìŠ¤ìºë„ˆ</h1>
        
        <div class="camera-section">
            <video id="camera" autoplay playsinline></video>
        </div>
        
        <div class="controls">
            <button id="startBtn">ğŸ“· í›„ë©´ ì¹´ë©”ë¼ ì‹œì‘</button>
            <button id="captureBtn" disabled>ğŸ“¸ ì‚¬ì§„ ì´¬ì˜</button>
            <button id="uploadBtn" class="upload-btn">ğŸ“ ì‚¬ì§„ ì—…ë¡œë“œ</button>
            <input type="file" id="fileInput" accept="image/*">
        </div>
        
        <div id="loading" class="loading">
            <p>ì²˜ë¦¬ ì¤‘...</p>
        </div>
        
        <div id="results" class="results">
            <h3>ë¶„ì„ ê²°ê³¼</h3>
            <div class="result-item">
                <strong>ë‚ ì§œ:</strong> <span id="resultDate">-</span>
            </div>
            <div class="result-item">
                <strong>ì—…ì²´ëª…:</strong> <span id="resultBusiness">-</span>
            </div>
            <div class="result-item">
                <strong>ê¸ˆì•¡:</strong> <span id="resultAmount">-</span>
            </div>
            <div class="result-item">
                <strong>ì ìš”:</strong> <span id="resultCategory">-</span>
            </div>
        </div>
        
        <div class="debug">
            <strong>ìƒíƒœ:</strong> <span id="status">í˜ì´ì§€ ë¡œë“œë¨</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        var stream = null;
        var imageData = null;
        var GOOGLE_API_KEY = 'AIzaSyAJFZI4cabXII5j7WBwqJkbACiyEOioyrg';
        var GOOGLE_VISION_URL = 'https://vision.googleapis.com/v1/images:annotate';
        var currentFacingMode = 'environment'; // í˜„ì¬ ì¹´ë©”ë¼ ëª¨ë“œ
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log(message);
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = function() {
            updateStatus('JavaScript ë¡œë“œ ì™„ë£Œ');
            
            // ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ í™•ì¸
            checkAvailableCameras();
            
            // ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
            document.getElementById('startBtn').onclick = startCamera;
            document.getElementById('captureBtn').onclick = capturePhoto;
            document.getElementById('uploadBtn').onclick = function() {
                document.getElementById('fileInput').click();
            };
            document.getElementById('fileInput').onchange = handleFile;
            
            updateStatus('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
        };
        
        // ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ í™•ì¸
        function checkAvailableCameras() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                updateStatus('ì¹´ë©”ë¼ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            navigator.mediaDevices.enumerateDevices()
                .then(function(devices) {
                    var videoDevices = devices.filter(function(device) {
                        return device.kind === 'videoinput';
                    });
                    
                    updateStatus('ì¹´ë©”ë¼ ' + videoDevices.length + 'ê°œ ê°ì§€ë¨');
                    console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼:', videoDevices);
                    
                    // ì¹´ë©”ë¼ê°€ 1ê°œë¿ì´ë©´ ì „í™˜ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                    if (videoDevices.length <= 1) {
                        document.getElementById('switchBtn').style.display = 'none';
                        updateStatus('ì¹´ë©”ë¼ 1ê°œ ê°ì§€ - ì „í™˜ ë²„íŠ¼ ìˆ¨ê¹€');
                    }
                })
                .catch(function(error) {
                    console.error('ì¹´ë©”ë¼ í™•ì¸ ì˜¤ë¥˜:', error);
                    updateStatus('ì¹´ë©”ë¼ í™•ì¸ ì˜¤ë¥˜: ' + error.message);
                });
        }
        
        // ì¹´ë©”ë¼ ì‹œì‘ (í›„ë©´ ì¹´ë©”ë¼ë§Œ)
        function startCamera() {
            updateStatus('í›„ë©´ ì¹´ë©”ë¼ ì‹œì‘ ì‹œë„ ì¤‘...');
            
            if (!navigator.mediaDevices) {
                alert('ì¹´ë©”ë¼ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                return;
            }
            
            // í›„ë©´ ì¹´ë©”ë¼ë§Œ ì‹œë„
            var constraints = {
                video: {
                    facingMode: 'environment', // í›„ë©´ ì¹´ë©”ë¼
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(mediaStream) {
                    stream = mediaStream;
                    var video = document.getElementById('camera');
                    video.srcObject = stream;
                    video.play();
                    
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('startBtn').textContent = 'ğŸ”„ ì¹´ë©”ë¼ ì¬ì‹œì‘';
                    updateStatus('í›„ë©´ ì¹´ë©”ë¼ ì‹œì‘ ì„±ê³µ! ì˜ìˆ˜ì¦ì„ ì°ì–´ë³´ì„¸ìš”');
                })
                .catch(function(error) {
                    console.error('í›„ë©´ ì¹´ë©”ë¼ ì˜¤ë¥˜:', error);
                    updateStatus('í›„ë©´ ì¹´ë©”ë¼ ì‹¤íŒ¨, ê¸°ë³¸ ì¹´ë©”ë¼ë¡œ ì‹œë„...');
                    
                    // í›„ë©´ ì¹´ë©”ë¼ ì‹¤íŒ¨ ì‹œ ê·¸ëƒ¥ ê¸°ë³¸ ì¹´ë©”ë¼
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(function(mediaStream) {
                            stream = mediaStream;
                            var video = document.getElementById('camera');
                            video.srcObject = stream;
                            video.play();
                            
                            document.getElementById('captureBtn').disabled = false;
                            document.getElementById('startBtn').textContent = 'ğŸ”„ ì¹´ë©”ë¼ ì¬ì‹œì‘';
                            updateStatus('ê¸°ë³¸ ì¹´ë©”ë¼ë¡œ ì‹œì‘ë¨');
                        })
                        .catch(function(error2) {
                            console.error('ëª¨ë“  ì¹´ë©”ë¼ ì˜¤ë¥˜:', error2);
                            updateStatus('ì¹´ë©”ë¼ ì˜¤ë¥˜: ' + error2.message);
                            alert('ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        });
                });
        }
        
        // ì‚¬ì§„ ì´¬ì˜
        function capturePhoto() {
            updateStatus('ì‚¬ì§„ ì´¬ì˜ ì¤‘...');
            
            var video = document.getElementById('camera');
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            imageData = canvas.toDataURL('image/jpeg');
            processImage();
        }
        
        // íŒŒì¼ ì—…ë¡œë“œ
        function handleFile(event) {
            updateStatus('íŒŒì¼ ì—…ë¡œë“œ ì¤‘...');
            
            var file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                return;
            }
            
            var reader = new FileReader();
            reader.onload = function(e) {
                imageData = e.target.result;
                processImage();
            };
            reader.readAsDataURL(file);
        }
        
        // ì´ë¯¸ì§€ ì²˜ë¦¬ (Tesseract.js OCR)
        function processImage() {
            updateStatus('Tesseract.jsë¡œ í…ìŠ¤íŠ¸ ì¸ì‹ ì¤‘...');
            
            // ë¡œë”© í‘œì‹œ
            document.getElementById('loading').className = 'loading show';
            document.getElementById('results').className = 'results';
            
            // ì§„í–‰ë¥  í‘œì‹œ
            var loadingText = document.querySelector('.loading p');
            loadingText.textContent = 'OCR ì—”ì§„ ì´ˆê¸°í™” ì¤‘...';
            
            // Tesseract.jsë¡œ OCR ìˆ˜í–‰
            Tesseract.recognize(
                imageData,
                'kor+eng', // í•œêµ­ì–´ + ì˜ì–´
                {
                    logger: function(m) {
                        console.log('OCR ì§„í–‰:', m);
                        if (m.status === 'recognizing text') {
                            var progress = Math.round(m.progress * 100);
                            loadingText.textContent = 'í…ìŠ¤íŠ¸ ì¸ì‹ ì¤‘... ' + progress + '%';
                            updateStatus('OCR ì§„í–‰ë¥ : ' + progress + '%');
                        } else if (m.status === 'loading language traineddata') {
                            loadingText.textContent = 'ì–¸ì–´ ë°ì´í„° ë¡œë”© ì¤‘...';
                            updateStatus('ì–¸ì–´ ë°ì´í„° ë¡œë”© ì¤‘...');
                        } else if (m.status === 'initializing tesseract') {
                            loadingText.textContent = 'OCR ì—”ì§„ ì´ˆê¸°í™” ì¤‘...';
                            updateStatus('OCR ì—”ì§„ ì´ˆê¸°í™” ì¤‘...');
                        }
                    }
                }
            ).then(function(result) {
                console.log('=== Tesseract.js ì „ì²´ ê²°ê³¼ ===');
                console.log(result);
                
                var fullText = result.data.text;
                console.log('=== ì¸ì‹ëœ ì „ì²´ í…ìŠ¤íŠ¸ ===');
                console.log(fullText);
                console.log('=== í…ìŠ¤íŠ¸ ê¸¸ì´ ===');
                console.log(fullText.length + 'ê¸€ì');
                
                if (fullText.trim().length > 0) {
                    var parsedResult = parseReceiptText(fullText);
                    console.log('=== íŒŒì‹± ê²°ê³¼ ===');
                    console.log(parsedResult);
                    
                    // ê²°ê³¼ í‘œì‹œ
                    document.getElementById('resultDate').textContent = parsedResult.date;
                    document.getElementById('resultBusiness').textContent = parsedResult.business;
                    document.getElementById('resultAmount').textContent = parsedResult.amount.toLocaleString() + 'ì›';
                    document.getElementById('resultCategory').textContent = parsedResult.category;
                    
                    updateStatus('OCR ì™„ë£Œ! í…ìŠ¤íŠ¸ ' + fullText.length + 'ê¸€ì ì¸ì‹ë¨');
                } else {
                    console.log('=== í…ìŠ¤íŠ¸ ì¸ì‹ ì‹¤íŒ¨ ===');
                    throw new Error('í…ìŠ¤íŠ¸ê°€ ì¸ì‹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                }
                
                // ë¡œë”© ìˆ¨ê¸°ê³  ê²°ê³¼ í‘œì‹œ
                document.getElementById('loading').className = 'loading';
                document.getElementById('results').className = 'results show';
                
            }).catch(function(error) {
                console.error('=== Tesseract.js ì˜¤ë¥˜ ===');
                console.error(error);
                updateStatus('OCR ì‹¤íŒ¨: ' + error.message);
                
                // OCR ì‹¤íŒ¨ ì‹œ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ëŒ€ì²´
                var result = getSimulationResult();
                document.getElementById('resultDate').textContent = result.date;
                document.getElementById('resultBusiness').textContent = result.business + ' (OCR ì‹¤íŒ¨)';
                document.getElementById('resultAmount').textContent = result.amount.toLocaleString() + 'ì›';
                document.getElementById('resultCategory').textContent = result.category;
                
                document.getElementById('loading').className = 'loading';
                document.getElementById('results').className = 'results show';
            });
        }
        
        // Google Vision API í˜¸ì¶œ í•¨ìˆ˜ ì œê±° (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        // ëŒ€ì‹  Tesseract.js ì‚¬ìš©
        
        // ì¸ì‹ëœ í…ìŠ¤íŠ¸ ë¶„ì„
        function parseReceiptText(text) {
            console.log('=== í…ìŠ¤íŠ¸ íŒŒì‹± ì‹œì‘ ===');
            console.log('ì›ë³¸ í…ìŠ¤íŠ¸:', text);
            
            var lines = text.split('\n').map(function(line) {
                return line.trim();
            }).filter(function(line) {
                return line.length > 0;
            });
            
            console.log('ë¶„í• ëœ ì¤„:', lines);
            
            var date = '';
            var business = '';
            var amount = 0;
            var category = '';
            
            // ë‚ ì§œ ì¶”ì¶œ
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                var dateMatch = line.match(/(\d{4})[.-/](\d{1,2})[.-/](\d{1,2})/);
                if (dateMatch) {
                    var year = dateMatch[1];
                    var month = dateMatch[2].padStart(2, '0');
                    var day = dateMatch[3].padStart(2, '0');
                    date = year + '-' + month + '-' + day;
                    console.log('ë‚ ì§œ ë°œê²¬:', date, '(ì›ë³¸:', line, ')');
                    break;
                }
            }
            
            // ì—…ì²´ëª… ì¶”ì¶œ (ì²« ë²ˆì§¸ ì˜ë¯¸ìˆëŠ” í…ìŠ¤íŠ¸)
            for (var i = 0; i < Math.min(5, lines.length); i++) {
                var line = lines[i];
                if (line.length > 2 && 
                    !line.match(/^\d+$/) && 
                    !line.match(/\d{4}[.-/]\d{1,2}[.-/]\d{1,2}/) &&
                    !line.includes('ì˜ìˆ˜ì¦') &&
                    !line.includes('receipt')) {
                    business = line;
                    console.log('ì—…ì²´ëª… ë°œê²¬:', business, '(ë¼ì¸', i, ')');
                    break;
                }
            }
            
            // ê¸ˆì•¡ ì¶”ì¶œ
            var amounts = [];
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                var numberMatches = line.match(/[\d,]+/g);
                if (numberMatches) {
                    for (var j = 0; j < numberMatches.length; j++) {
                        var cleanNumber = numberMatches[j].replace(/,/g, '');
                        var num = parseInt(cleanNumber);
                        if (num >= 100 && num <= 1000000) {
                            amounts.push(num);
                            console.log('ê¸ˆì•¡ í›„ë³´:', num, '(ì›ë³¸:', line, ')');
                        }
                    }
                }
            }
            if (amounts.length > 0) {
                amount = Math.max.apply(Math, amounts);
                console.log('ìµœì¢… ê¸ˆì•¡:', amount);
            }
            
            // ì ìš” ìë™ ë¶„ë¥˜
            var fullTextLower = text.toLowerCase();
            var businessLower = business.toLowerCase();
            console.log('ë¶„ë¥˜ìš© í…ìŠ¤íŠ¸:', businessLower);
            
            if (businessLower.includes('ìŠ¤íƒ€ë²…ìŠ¤') || businessLower.includes('ì¹´í˜') || businessLower.includes('ì»¤í”¼')) {
                category = 'ê°„ì‹ëŒ€';
            } else if (businessLower.includes('ë§¥ë„ë‚ ë“œ') || businessLower.includes('ë²„ê±°') || businessLower.includes('ì‹ë‹¹')) {
                category = 'ì‹ëŒ€';
            } else if (businessLower.includes('gs25') || businessLower.includes('í¸ì˜ì ') || businessLower.includes('cu')) {
                category = 'ê°„ì‹ëŒ€';
            } else if (businessLower.includes('ì£¼ìœ ì†Œ') || businessLower.includes('ì¹¼í…ìŠ¤') || businessLower.includes('skì—ë„ˆì§€')) {
                category = 'ìœ ë¥˜ëŒ€';
            } else if (businessLower.includes('í•œêµ­ë„ë¡œê³µì‚¬') || fullTextLower.includes('í†µí–‰ë£Œ')) {
                category = 'í†µí–‰ë£Œ';
            } else if (businessLower.includes('íƒì‹œ') || fullTextLower.includes('íƒì‹œ')) {
                category = 'íƒì‹œë¹„';
            } else if (fullTextLower.includes('ì§€í•˜ì² ') || fullTextLower.includes('ë²„ìŠ¤')) {
                category = 'êµí†µë¹„';
            } else {
                category = 'ê¸°íƒ€';
            }
            
            console.log('=== ìµœì¢… íŒŒì‹± ê²°ê³¼ ===');
            var result = {
                date: date || new Date().toISOString().split('T')[0],
                business: business || 'ì¸ì‹ ì‹¤íŒ¨',
                amount: amount || 0,
                category: category
            };
            console.log(result);
            
            return result;
        }
        
        // ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ (OCR ì‹¤íŒ¨ ì‹œ ë°±ì—…)
        function getSimulationResult() {
                var businesses = ['ìŠ¤íƒ€ë²…ìŠ¤', 'ë§¥ë„ë‚ ë“œ', 'GS25', 'ì´ë§ˆíŠ¸', 'ë¡¯ë°ë¦¬ì•„'];
                var categories = ['ê°„ì‹ëŒ€', 'ì‹ëŒ€', 'ìƒí•„í’ˆ', 'êµí†µë¹„'];
                
                var business = businesses[Math.floor(Math.random() * businesses.length)];
                var amount = Math.floor(Math.random() * 50000) + 1000;
                var category = categories[Math.floor(Math.random() * categories.length)];
                var today = new Date().toISOString().split('T')[0];
                
                return {
                    date: today,
                    business: business,
                    amount: amount,
                    category: category
                };
            }
    </script>
</body>
</html>
